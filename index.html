<!DOCTYPE html>
<html lang="ar" dir="rtl" id="htmlRoot">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISBAR Summary - Nursing Handover</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <!-- PDF / Image export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Colors inspired by your current PDF palette */
      --primary: #434E78;      /* blue */
      --secondary: #607B8F;    /* blue/gray */
      --accentY: #F7E396;      /* yellow */
      --accentO: #E97F4A;      /* orange */
      --bg: #121521;
      --surface: #1b2031;
      --surface2:#232a3f;
      --text: #f3f4f6;
      --muted:#b9c0d4;
      --border:#36405e;
      --danger:#ef4444;
      --ok:#10b981;
    }

    body{
      background: radial-gradient(1000px 600px at 10% 0%, rgba(67,78,120,.35), transparent 60%),
                  radial-gradient(1000px 600px at 90% 20%, rgba(233,127,74,.22), transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: Cairo, Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    /* Re-usable */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      overflow: hidden;
    }

    .cardHeader{
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      padding: 14px 16px;
      font-weight: 800;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .badgeEdit{
      display:none;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(247,227,150,.16);
      border: 1px solid rgba(247,227,150,.35);
      color: var(--accentY);
      font-weight: 700;
      font-size: 12px;
      white-space: nowrap;
    }

    .field{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--accentY);
      font-weight: 800;
      margin-bottom: 6px;
    }
    .field input, .field textarea, .field select{
      width: 100%;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .field input:focus, .field textarea:focus, .field select:focus{
      border-color: rgba(247,227,150,.55);
      box-shadow: 0 0 0 3px rgba(247,227,150,.18);
    }
    textarea{ min-height: 90px; resize: vertical; }

    .btn{
      border-radius: 12px;
      padding: 11px 14px;
      font-weight: 800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border: 1px solid transparent;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btnPrimary{ background: var(--accentO); color:white; }
    .btnPrimary:hover{ filter: brightness(1.05); }
    .btnSecondary{ background: rgba(96,123,143,.25); border-color: rgba(96,123,143,.45); }
    .btnGhost{ background: transparent; border-color: rgba(255,255,255,.14); color: var(--text); }
    .btnDanger{ background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.35); color: #fecaca; }

    .chip{
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.12);
      color: var(--text);
      font-weight: 800;
      font-size: 12px;
    }
    .chipActive{
      background: rgba(247,227,150,.16);
      border-color: rgba(247,227,150,.45);
      color: var(--accentY);
    }

    /* Medication items */
    .medItem{
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
    }

    /* Hidden export sheet: move it far offscreen (do NOT use display:none or opacity:0) */
    #exportArea{
      position: fixed;
      left: -100000px;
      top: 0;
      width: 1123px;
      height: 794px;
      overflow: visible;
      pointer-events: none;
    }

    .sheet{
      width: 1123px; /* A4 landscape at ~96dpi */
      height: 794px;
      background: #fff;
      color: #111;
      border: 2px solid #111;
      box-sizing: border-box;
      position: relative;
      font-family: Cairo, Inter, sans-serif;
    }
    .sheet *{ box-sizing: border-box; }

    .sheetSidebar{
      position:absolute;
      top:0;
      right:0;
      width: 84px;
      height: 100%;
      background: #d6d6d6;
      border-left: 2px solid #111;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .sheetSidebar span{
      transform: rotate(90deg);
      font-weight: 800;
      letter-spacing: 1px;
      font-size: 16px;
    }

    .sheetContent{
      position:absolute;
      top:0;
      left:0;
      right:84px;
      bottom:0;
      padding: 12px;
    }

    .sheetHeader{
      border: 2px solid #111;
      background: #efefef;
      padding: 8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .sheetHeader .title{
      font-weight: 900;
      font-size: 18px;
      color: #111;
    }
    .sheetHeader .meta{
      font-size: 12px;
      font-weight: 700;
      color:#222;
    }

    .sheetGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      height: calc(100% - 64px);
    }

    .sheetSection{
      border: 2px solid #111;
      display:flex;
      flex-direction:column;
      min-height: 0;
      overflow: hidden;
    }
    .sheetSectionTitle{
      background: #e5e5e5;
      border-bottom: 2px solid #111;
      padding: 5px 8px;
      font-weight: 900;
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .sheetSectionBody{
      flex: 1;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }

    .sheetRow{
      display:grid;
      grid-template-columns: 150px 1fr;
      border-bottom: 1px solid #111;
      min-height: 24px;
    }
    .sheetRow:last-child{ border-bottom: none; }
    .sheetLabel{
      background:#f4f4f4;
      border-right: 1px solid #111;
      padding: 4px 6px;
      font-weight: 800;
      font-size: 11px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .sheetValue{
      padding: 4px 6px;
      font-size: 11px;
      white-space: pre-wrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sheetValue.small{ font-size: 10px; }

    /* RTL tweaks inside sheet */
    .sheet[dir="rtl"] .sheetRow{ grid-template-columns: 1fr 150px; }
    .sheet[dir="rtl"] .sheetLabel{
      border-right: none;
      border-left: 1px solid #111;
      justify-content:flex-end;
      text-align:right;
    }
    .sheet[dir="rtl"] .sheetValue{ text-align:right; }

    /* Tall fields (complaints/diagnosis etc.) */
    .sheetRow.tall{
      min-height: 92px;
    }
    .sheetRow.tall .sheetValue{
      padding-top: 6px;
      line-height: 1.25;
    }

    /* Medications table */
    .sheetTable{
      width:100%;
      border-collapse: collapse;
      font-size: 10px;
    }
    .sheetTable th, .sheetTable td{
      border: 1px solid #111;
      padding: 4px 5px;
      vertical-align: top;
    }
    .sheetTable th{
      background:#f4f4f4;
      font-weight: 900;
    }

    .sheetFooter{
      position:absolute;
      left:12px;
      right:96px;
      bottom:12px;
      border: 2px solid #111;
      background:#fafafa;
      padding: 8px 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 11px;
      font-weight: 700;
    }
    .sheetFooter .line{
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .sheetFooter .line .v{
      font-weight: 900;
    }

    @media (max-width: 768px){
      .stickyHeaderFix{ position: sticky; top: 0; z-index: 40; }
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Top bar -->
  <div class="stickyHeaderFix border-b border-white/5 bg-[rgba(18,21,33,.75)] backdrop-blur-xl">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl" style="background: linear-gradient(135deg, var(--accentO), var(--primary));"></div>
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold" data-i18n="appTitle">ISBAR Summary</h1>
          <p class="text-sm text-[color:var(--muted)]" data-i18n="appSubtitle">نظام تسليم وتسلم المريض</p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2 justify-between sm:justify-end">
        <div class="flex items-center gap-2">
          <button class="chip chipActive" id="langArBtn" type="button" onclick="setLanguage('ar')">العربية</button>
          <button class="chip" id="langEnBtn" type="button" onclick="setLanguage('en')">English</button>
        </div>

        <button class="btn btnGhost" type="button" onclick="newPatient()">
          <span data-i18n="btnNew">مريض جديد</span>
        </button>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <!-- Form Card -->
    <div class="card">
      <div class="cardHeader">
        <div class="flex items-center gap-3">
          <span class="text-white font-black" data-i18n="formTitle">بيانات المريض (ISBAR)</span>
          <span class="badgeEdit" id="editingBadge" data-i18n="editingBadge">وضع التعديل</span>
        </div>
        <div class="text-white/90 text-xs font-bold" id="editingInfo"></div>
      </div>

      <div class="p-4 sm:p-6 space-y-6">

        <!-- Identification -->
        <section class="card border border-white/5 shadow-none">
          <div class="cardHeader" style="background: linear-gradient(90deg, var(--primary), var(--primary));">
            <span data-i18n="secIdentification">I - الهوية</span>
          </div>

          <div class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="field">
              <label data-i18n="labelRoom">رقم الغرفة</label>
              <input id="room" type="text" inputmode="numeric" dir="auto" placeholder="101"/>
            </div>

            <div class="field">
              <label data-i18n="labelMrn">رقم الملف / ID</label>
              <input id="mrn" type="text" dir="auto" placeholder="MRN-0001"/>
            </div>

            <div class="field">
              <label data-i18n="labelPtName">اسم المريض</label>
              <input id="ptName" type="text" dir="auto" placeholder="أحمد محمد"/>
            </div>

            <div class="field">
              <label data-i18n="labelAge">العمر</label>
              <input id="age" type="text" inputmode="numeric" dir="auto" placeholder="45"/>
            </div>

            <div class="field">
              <label data-i18n="labelAdmDate">تاريخ القبول</label>
              <input id="admDate" type="date" dir="ltr"/>
            </div>

            <div class="field">
              <label data-i18n="labelAdmFrom">قادم من</label>
              <input id="admFrom" type="text" dir="auto" placeholder="ER"/>
            </div>

            <div class="field sm:col-span-2 lg:col-span-3">
              <label data-i18n="labelConsultant">الطبيب المعالج</label>
              <input id="consultant" type="text" dir="auto" placeholder="د. علي أحمد"/>
            </div>
          </div>
        </section>

        <!-- Situation -->
        <section class="card border border-white/5 shadow-none">
          <div class="cardHeader" style="background: linear-gradient(90deg, var(--secondary), var(--secondary));">
            <span data-i18n="secSituation">S - الحالة</span>
          </div>

          <div class="p-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="field">
              <label data-i18n="labelComplaints">الشكاوى الحالية</label>
              <textarea id="complaints" dir="auto" placeholder="..."></textarea>
            </div>
            <div class="field">
              <label data-i18n="labelDiagnosis">التشخيص</label>
              <textarea id="diagnosis" dir="auto" placeholder="..."></textarea>
            </div>

            <div class="field">
              <label data-i18n="labelConnection">Connections</label>
              <textarea id="connection" dir="auto" placeholder="RT CVL - 12/4"></textarea>
            </div>
            <div class="field">
              <label data-i18n="labelInfusion">Infusions</label>
              <textarea id="infusion" dir="auto" placeholder="D10% - R10"></textarea>
            </div>

            <div class="field lg:col-span-2">
              <label data-i18n="labelDiet">Diet</label>
              <input id="diet" type="text" dir="auto" placeholder="NPO"/>
            </div>
          </div>
        </section>

        <!-- Background -->
        <section class="card border border-white/5 shadow-none">
          <div class="cardHeader" style="background: linear-gradient(90deg, var(--accentO), var(--accentO));">
            <span data-i18n="secBackground">B - الخلفية</span>
          </div>

          <div class="p-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="field">
              <label data-i18n="labelHistory">التاريخ المرضي</label>
              <textarea id="history" dir="auto"></textarea>
            </div>
            <div class="field">
              <label data-i18n="labelChiefComplaint">الشكوى الرئيسية عند القبول</label>
              <textarea id="chiefComplaint" dir="auto"></textarea>
            </div>
            <div class="field">
              <label data-i18n="labelAllergy">الحساسية</label>
              <input id="allergy" type="text" dir="auto" placeholder="Penicillin"/>
            </div>
            <div class="field">
              <label data-i18n="labelIsolation">العزل / العدوى</label>
              <input id="isolation" type="text" dir="auto" placeholder="Contact"/>
            </div>
          </div>
        </section>

        <!-- Medications -->
        <section class="card border border-white/5 shadow-none">
          <div class="cardHeader">
            <span data-i18n="secMedications">الأدوية</span>
            <button class="btn btnPrimary" type="button" onclick="addMedication()">
              <span data-i18n="btnAddMed">+ إضافة دواء</span>
            </button>
          </div>

          <div class="p-4 space-y-3" id="medicationsContainer">
            <div id="noMeds" class="text-center text-sm text-[color:var(--muted)] py-4" data-i18n="noMeds">
              لم يتم إضافة أدوية بعد.
            </div>
          </div>
        </section>

        <!-- Assessment -->
        <section class="card border border-white/5 shadow-none">
          <div class="cardHeader" style="background: linear-gradient(90deg, var(--secondary), var(--primary));">
            <span data-i18n="secAssessment">A - التقييم</span>
          </div>

          <div class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="field">
              <label data-i18n="labelGCS">GCS</label>
              <input id="gcs" type="text" dir="auto" placeholder="15"/>
            </div>
            <div class="field">
              <label data-i18n="labelFallRisk">Fall risk</label>
              <input id="fallRisk" type="text" dir="auto" placeholder="High"/>
            </div>
            <div class="field">
              <label data-i18n="labelVent">Ventilation</label>
              <input id="vent" type="text" dir="auto" placeholder="No"/>
            </div>
            <div class="field">
              <label data-i18n="labelBedsore">Bed sore</label>
              <input id="bedsore" type="text" dir="auto" placeholder="Stage 2"/>
            </div>
            <div class="field">
              <label data-i18n="labelRestraint">Physical restraint</label>
              <input id="restraint" type="text" dir="auto" placeholder="No"/>
            </div>
            <div class="field sm:col-span-2 lg:col-span-3">
              <label data-i18n="labelFindings">Significant findings</label>
              <textarea id="findings" dir="auto"></textarea>
            </div>
          </div>
        </section>

        <!-- Recommendation -->
        <section class="card border border-white/5 shadow-none">
          <div class="cardHeader" style="background: linear-gradient(90deg, var(--accentY), #ffffff); color:#111;">
            <span data-i18n="secRecommendation">R - التوصيات</span>
          </div>

          <div class="p-4 grid grid-cols-1 gap-4">
            <div class="field">
              <label data-i18n="labelPlan">Plan of care</label>
              <textarea id="plan" dir="auto"></textarea>
            </div>
            <div class="field">
              <label data-i18n="labelOrders">Physician orders</label>
              <textarea id="orders" dir="auto"></textarea>
            </div>
            <div class="field">
              <label data-i18n="labelCultures">Cultures & sensitivity</label>
              <textarea id="cultures" dir="auto"></textarea>
            </div>
            <div class="field">
              <label data-i18n="labelConsult">Consultation</label>
              <textarea id="consult" dir="auto"></textarea>
            </div>
            <div class="field">
              <label data-i18n="labelRisks">Risks</label>
              <textarea id="risks" dir="auto"></textarea>
            </div>
          </div>
        </section>

        <!-- Signature -->
        <section class="card border border-white/5 shadow-none">
          <div class="cardHeader" style="background: linear-gradient(90deg, rgba(255,255,255,.07), rgba(255,255,255,.03));">
            <span data-i18n="secSignature">التوقيع</span>
          </div>
          <div class="p-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="field">
              <label data-i18n="labelNurseSignature">اسم الممرض المسلم / التوقيع في الملف</label>
              <input id="nurseSignature" type="text" dir="auto" placeholder="MR." value="MR. "/>
            </div>
            <div class="field">
              <label data-i18n="labelReceivingNurse">اسم الممرض المستلم</label>
              <input id="receivingNurse" type="text" dir="auto" placeholder="..."/>
            </div>
          </div>
        </section>

        <!-- Actions -->
        <div class="flex flex-wrap gap-3 justify-center pt-2">
          <button class="btn btnPrimary" type="button" onclick="savePatient()">
            <span id="saveBtnText" data-i18n="btnSave">حفظ</span>
          </button>

          <button class="btn btnSecondary" type="button" onclick="clearForm(true)">
            <span data-i18n="btnClear">مسح النموذج</span>
          </button>

          <button class="btn btnGhost" type="button" id="cancelEditBtn" onclick="cancelEdit()" style="display:none;">
            <span data-i18n="btnCancelEdit">إلغاء التعديل</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Export -->
    <div class="card p-4 sm:p-6">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
        <div>
          <h2 class="text-xl font-extrabold" data-i18n="exportTitle">التصدير</h2>
          <p class="text-sm text-[color:var(--muted)]" data-i18n="exportHint">تصدير PDF بالشكل الخاص بورقة تسليم/تسلم (كصورة) + تصدير/استيراد JSON.</p>
        </div>
        <div class="flex gap-2">
          <button class="btn btnGhost" type="button" onclick="exportAllPatientsJSON()">
            <span data-i18n="btnExportJSON">تصدير كل المرضى (JSON)</span>
          </button>

          <label class="btn btnGhost cursor-pointer">
            <input type="file" accept="application/json" class="hidden" onchange="importPatientsJSON(this.files[0])">
            <span data-i18n="btnImportJSON">استيراد JSON</span>
          </label>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
        <button class="btn btnPrimary" type="button" onclick="exportHandoverPDF('ar')">
          <span data-i18n="btnExportPdfAr">تصدير PDF عربي (نموذج)</span>
        </button>
        <button class="btn btnPrimary" type="button" onclick="exportHandoverPDF('en')">
          <span data-i18n="btnExportPdfEn">Export English PDF (Form)</span>
        </button>
        <button class="btn btnSecondary" type="button" onclick="exportMedicationsCSV()">
          <span data-i18n="btnExportMedsCsv">تصدير الأدوية CSV</span>
        </button>
      </div>

      <div class="mt-3 text-xs text-[color:var(--muted)]" data-i18n="privacyNote">
        ملاحظة: البيانات تُحفظ محليًا داخل المتصفح (LocalStorage). لو الجهاز مش آمن، لا تحفظ بيانات حساسة.
      </div>
    </div>

    <!-- Patients list -->
    <div class="card p-4 sm:p-6">
      <div class="flex flex-col lg:flex-row gap-3 lg:items-center lg:justify-between">
        <div>
          <h2 class="text-xl font-extrabold" data-i18n="patientsTitle">قائمة المرضى</h2>
          <p class="text-sm text-[color:var(--muted)]" data-i18n="patientsHint">تقدر تحمل المريض وتعدّل بياناته وتعمل تحديث بدل إضافة نسخة جديدة.</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-2">
          <input id="searchPatient" type="text" class="w-full sm:w-80 rounded-xl bg-[rgba(0,0,0,.12)] border border-white/10 px-4 py-3 text-sm"
                 placeholder="بحث..." oninput="renderPatientsList(this.value)">
          <button class="btn btnDanger" type="button" onclick="deleteAllPatients()">
            <span data-i18n="btnDeleteAll">حذف الجميع</span>
          </button>
        </div>
      </div>

      <div class="mt-4 space-y-3" id="patientsList"></div>

      <div class="mt-3 text-xs text-[color:var(--muted)]" id="patientsCount"></div>
    </div>

  </div>

  <!-- Offscreen export sheet -->
  <div id="exportArea" aria-hidden="true">
    <div id="exportSheet" class="sheet" dir="rtl" lang="ar">
      <div class="sheetSidebar"><span id="sheetSideTitle">Nursing Handover</span></div>

      <div class="sheetContent">
        <div class="sheetHeader">
          <div>
            <div class="title" id="sheetTitle">Nursing Handover</div>
            <div class="meta" id="sheetSub">ISBAR Summary</div>
          </div>
          <div class="meta">
            <div><span id="sheetMetaDateLabel">Date</span>: <span data-sheet-value="exportDate"></span></div>
            <div><span id="sheetMetaTimeLabel">Time</span>: <span data-sheet-value="exportTime"></span></div>
          </div>
        </div>

        <div class="sheetGrid">
          <!-- Left column -->
          <div class="sheetSection">
            <div class="sheetSectionTitle"><span id="sheetSecI">Identification</span><span style="font-size:11px;font-weight:800;">I</span></div>
            <div class="sheetSectionBody">
              <div class="sheetRow">
                <div class="sheetLabel" id="shRoom">Room No</div>
                <div class="sheetValue" data-sheet-value="room"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shMrn">MRN / ID</div>
                <div class="sheetValue" data-sheet-value="mrn"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shName">Patient Name</div>
                <div class="sheetValue" data-sheet-value="ptName"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shAge">Age</div>
                <div class="sheetValue" data-sheet-value="age"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shAdmDate">Admission Date</div>
                <div class="sheetValue" data-sheet-value="admDate"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shAdmFrom">Admission From</div>
                <div class="sheetValue" data-sheet-value="admFrom"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shConsultant">Consultant</div>
                <div class="sheetValue" data-sheet-value="consultant"></div>
              </div>
            </div>
          </div>

          <!-- Right column -->
          <div class="sheetSection">
            <div class="sheetSectionTitle"><span id="sheetSecS">Situation</span><span style="font-size:11px;font-weight:800;">S</span></div>
            <div class="sheetSectionBody">
              <div class="sheetRow tall">
                <div class="sheetLabel" id="shComplaints">Current Complaints</div>
                <div class="sheetValue" data-sheet-value="complaints"></div>
              </div>
              <div class="sheetRow tall">
                <div class="sheetLabel" id="shDiagnosis">Diagnosis</div>
                <div class="sheetValue" data-sheet-value="diagnosis"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shConnection">Connections</div>
                <div class="sheetValue" data-sheet-value="connection"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shInfusion">Infusions</div>
                <div class="sheetValue" data-sheet-value="infusion"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shDiet">Diet</div>
                <div class="sheetValue" data-sheet-value="diet"></div>
              </div>
            </div>
          </div>

          <!-- Left bottom -->
          <div class="sheetSection">
            <div class="sheetSectionTitle"><span id="sheetSecB">Background</span><span style="font-size:11px;font-weight:800;">B</span></div>
            <div class="sheetSectionBody">
              <div class="sheetRow tall">
                <div class="sheetLabel" id="shHistory">History</div>
                <div class="sheetValue" data-sheet-value="history"></div>
              </div>
              <div class="sheetRow tall">
                <div class="sheetLabel" id="shChief">Chief Complaint</div>
                <div class="sheetValue" data-sheet-value="chiefComplaint"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shAllergy">Allergy</div>
                <div class="sheetValue" data-sheet-value="allergy"></div>
              </div>
              <div class="sheetRow">
                <div class="sheetLabel" id="shIsolation">Isolation</div>
                <div class="sheetValue" data-sheet-value="isolation"></div>
              </div>
            </div>
          </div>

          <!-- Right bottom -->
          <div class="sheetSection">
            <div class="sheetSectionTitle"><span id="sheetSecA">Assessment & Recommendations</span><span style="font-size:11px;font-weight:800;">A/R</span></div>
            <div class="sheetSectionBody" style="display:grid; grid-template-rows: auto auto 1fr; gap:0;">
              <div style="border-bottom:2px solid #111;">
                <div class="sheetRow">
                  <div class="sheetLabel" id="shGcs">GCS</div>
                  <div class="sheetValue" data-sheet-value="gcs"></div>
                </div>
                <div class="sheetRow">
                  <div class="sheetLabel" id="shFall">Fall Risk</div>
                  <div class="sheetValue" data-sheet-value="fallRisk"></div>
                </div>
                <div class="sheetRow">
                  <div class="sheetLabel" id="shVent">Ventilation</div>
                  <div class="sheetValue" data-sheet-value="vent"></div>
                </div>
                <div class="sheetRow">
                  <div class="sheetLabel" id="shBedsore">Bed sore</div>
                  <div class="sheetValue" data-sheet-value="bedsore"></div>
                </div>
                <div class="sheetRow">
                  <div class="sheetLabel" id="shRestraint">Restraint</div>
                  <div class="sheetValue" data-sheet-value="restraint"></div>
                </div>
              </div>

              <div style="border-bottom:2px solid #111;">
                <div class="sheetRow tall">
                  <div class="sheetLabel" id="shFindings">Significant findings</div>
                  <div class="sheetValue small" data-sheet-value="findings"></div>
                </div>
              </div>

              <div style="display:grid; grid-template-columns: 1fr; min-height:0;">
                <div style="border-bottom:1px solid #111; padding:6px 8px; font-weight:900; font-size:12px;" id="shMedsTitle">Medications</div>
                <div style="padding:6px 8px; min-height:0; overflow:hidden;">
                  <table class="sheetTable">
                    <thead>
                      <tr>
                        <th id="shMedName">Name</th>
                        <th id="shMedDose">Dose</th>
                        <th id="shMedFreq">Frequency</th>
                        <th id="shMedRoute">Route</th>
                      </tr>
                    </thead>
                    <tbody id="sheetMedsBody"></tbody>
                  </table>
                  <div style="margin-top:6px; display:grid; gap:6px;">
                    <div style="border-top:1px solid #111; padding-top:6px;">
                      <div style="font-weight:900; font-size:11px;" id="shPlanTitle">Plan / Orders</div>
                      <div class="sheetValue small" data-sheet-value="plan"></div>
                      <div class="sheetValue small" data-sheet-value="orders"></div>
                    </div>
                    <div style="border-top:1px solid #111; padding-top:6px;">
                      <div style="font-weight:900; font-size:11px;" id="shRisksTitle">Risks / Consultations</div>
                      <div class="sheetValue small" data-sheet-value="consult"></div>
                      <div class="sheetValue small" data-sheet-value="risks"></div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>

        <div class="sheetFooter">
          <div class="line"><span id="shNurseLabel">Handover nurse</span>: <span class="v" data-sheet-value="nurseSignature"></span></div>
          <div class="line"><span id="shRecvLabel">Receiving nurse</span>: <span class="v" data-sheet-value="receivingNurse"></span></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const { jsPDF } = window.jspdf;

  // =========================
  // i18n
  // =========================
  const i18n = {
    ar: {
      appTitle: "ISBAR Summary",
      appSubtitle: "نظام تسليم وتسلم المريض",
      formTitle: "بيانات المريض (ISBAR)",
      editingBadge: "وضع التعديل",
      secIdentification: "I - الهوية",
      secSituation: "S - الحالة",
      secBackground: "B - الخلفية",
      secMedications: "الأدوية",
      secAssessment: "A - التقييم",
      secRecommendation: "R - التوصيات",
      secSignature: "التوقيع",
      labelRoom: "رقم الغرفة",
      labelMrn: "رقم الملف / ID",
      labelPtName: "اسم المريض",
      labelAge: "العمر",
      labelAdmDate: "تاريخ القبول",
      labelAdmFrom: "قادم من",
      labelConsultant: "الطبيب المعالج",
      labelComplaints: "الشكاوى الحالية",
      labelDiagnosis: "التشخيص",
      labelConnection: "الاتصالات / Connections",
      labelInfusion: "المحاليل / Infusions",
      labelDiet: "الحمية / Diet",
      labelHistory: "التاريخ المرضي",
      labelChiefComplaint: "الشكوى الرئيسية عند القبول",
      labelAllergy: "الحساسية",
      labelIsolation: "العزل / العدوى",
      labelGCS: "مقياس غلاسكو (GCS)",
      labelFallRisk: "خطر السقوط",
      labelVent: "التنفس الصناعي",
      labelBedsore: "قرحة الفراش",
      labelRestraint: "التقييد البدني",
      labelFindings: "ملاحظات/نتائج هامة",
      labelPlan: "خطة الرعاية",
      labelOrders: "أوامر الطبيب",
      labelCultures: "مزارع وحساسية",
      labelConsult: "استشارات",
      labelRisks: "مخاطر",
      labelNurseSignature: "اسم الممرض المسلم / التوقيع في الملف",
      labelReceivingNurse: "اسم الممرض المستلم",
      btnAddMed: "+ إضافة دواء",
      noMeds: "لم يتم إضافة أدوية بعد.",
      btnSave: "حفظ",
      btnUpdate: "تحديث بيانات المريض",
      btnClear: "مسح النموذج",
      btnCancelEdit: "إلغاء التعديل",
      btnNew: "مريض جديد",
      exportTitle: "التصدير",
      exportHint: "تصدير PDF بالشكل الخاص بورقة تسليم/تسلم (كصورة) + تصدير/استيراد JSON.",
      btnExportPdfAr: "تصدير PDF عربي (نموذج)",
      btnExportPdfEn: "تصدير PDF English (Form)",
      btnExportMedsCsv: "تصدير الأدوية CSV",
      btnExportJSON: "تصدير كل المرضى (JSON)",
      btnImportJSON: "استيراد JSON",
      privacyNote: "ملاحظة: البيانات تُحفظ محليًا داخل المتصفح (LocalStorage). لو الجهاز مش آمن، لا تحفظ بيانات حساسة.",
      patientsTitle: "قائمة المرضى",
      patientsHint: "تقدر تحمل المريض وتعدّل بياناته وتعمل تحديث بدل إضافة نسخة جديدة.",
      btnDeleteAll: "حذف الجميع",
      searchPlaceholder: "بحث بالاسم / الغرفة / رقم الملف...",
      // Med item
      medName: "اسم الدواء",
      medDose: "الجرعة",
      medFreq: "التكرار",
      medRoute: "طريقة الإعطاء",
      medNotes: "ملاحظات",
      btnDelete: "حذف",
      // Sheet labels
      sheetTitle: "ورقة تسليم / تسلم التمريض",
      sheetSub: "ملخص ISBAR",
      sheetSide: "Nursing Handover",
      sheetMetaDate: "التاريخ",
      sheetMetaTime: "الوقت",
      shRoom: "رقم الغرفة",
      shMrn: "رقم الملف / ID",
      shName: "اسم المريض",
      shAge: "العمر",
      shAdmDate: "تاريخ القبول",
      shAdmFrom: "قادم من",
      shConsultant: "الطبيب المعالج",
      shComplaints: "الشكاوى الحالية",
      shDiagnosis: "التشخيص",
      shConnection: "الاتصالات",
      shInfusion: "المحاليل",
      shDiet: "الحمية",
      shHistory: "التاريخ المرضي",
      shChief: "الشكوى الرئيسية",
      shAllergy: "الحساسية",
      shIsolation: "العزل",
      shGcs: "GCS",
      shFall: "خطر السقوط",
      shVent: "Vent",
      shBedsore: "Bed sore",
      shRestraint: "Restraint",
      shFindings: "ملاحظات هامة",
      shMedsTitle: "الأدوية",
      shMedName: "اسم",
      shMedDose: "جرعة",
      shMedFreq: "تكرار",
      shMedRoute: "Route",
      shPlanTitle: "خطة / أوامر",
      shRisksTitle: "مخاطر / استشارات",
      shNurseLabel: "الممرض المسلم",
      shRecvLabel: "الممرض المستلم",
      sheetSecI: "الهوية",
      sheetSecS: "الحالة",
      sheetSecB: "الخلفية",
      sheetSecA: "التقييم والتوصيات"
    },
    en: {
      appTitle: "ISBAR Summary",
      appSubtitle: "Patient Handover System",
      formTitle: "Patient Data (ISBAR)",
      editingBadge: "Editing",
      secIdentification: "I - Identification",
      secSituation: "S - Situation",
      secBackground: "B - Background",
      secMedications: "Medications",
      secAssessment: "A - Assessment",
      secRecommendation: "R - Recommendation",
      secSignature: "Signature",
      labelRoom: "Room No",
      labelMrn: "MRN / ID",
      labelPtName: "Patient Name",
      labelAge: "Age",
      labelAdmDate: "Admission Date",
      labelAdmFrom: "Admission From",
      labelConsultant: "Consultant",
      labelComplaints: "Current Complaints",
      labelDiagnosis: "Diagnosis",
      labelConnection: "Connections",
      labelInfusion: "Infusions",
      labelDiet: "Diet",
      labelHistory: "History",
      labelChiefComplaint: "Chief Complaint on Admission",
      labelAllergy: "Allergy",
      labelIsolation: "Isolation / Infection",
      labelGCS: "GCS",
      labelFallRisk: "Fall Risk",
      labelVent: "Ventilation",
      labelBedsore: "Bed Sore",
      labelRestraint: "Restraint",
      labelFindings: "Significant Findings",
      labelPlan: "Plan of Care",
      labelOrders: "Physician Orders",
      labelCultures: "Cultures & Sensitivity",
      labelConsult: "Consultation",
      labelRisks: "Risks",
      labelNurseSignature: "Handover Nurse Name / File Signature",
      labelReceivingNurse: "Receiving Nurse",
      btnAddMed: "+ Add medication",
      noMeds: "No medications added yet.",
      btnSave: "Save",
      btnUpdate: "Update patient",
      btnClear: "Clear form",
      btnCancelEdit: "Cancel edit",
      btnNew: "New patient",
      exportTitle: "Export",
      exportHint: "Export a PDF in the nursing handover form layout (as an image) + JSON import/export.",
      btnExportPdfAr: "Export Arabic PDF (Form)",
      btnExportPdfEn: "Export English PDF (Form)",
      btnExportMedsCsv: "Export meds CSV",
      btnExportJSON: "Export all patients (JSON)",
      btnImportJSON: "Import JSON",
      privacyNote: "Note: Data is saved locally in the browser (LocalStorage). Avoid saving sensitive data on an unsafe device.",
      patientsTitle: "Patients",
      patientsHint: "Load a patient, edit, then update instead of creating a duplicate record.",
      btnDeleteAll: "Delete all",
      searchPlaceholder: "Search by name / room / MRN...",
      // Med item
      medName: "Medication Name",
      medDose: "Dose",
      medFreq: "Frequency",
      medRoute: "Route",
      medNotes: "Notes",
      btnDelete: "Delete",
      // Sheet labels
      sheetTitle: "Nursing Handover Sheet",
      sheetSub: "ISBAR Summary",
      sheetSide: "Nursing Handover",
      sheetMetaDate: "Date",
      sheetMetaTime: "Time",
      shRoom: "Room No",
      shMrn: "MRN / ID",
      shName: "Patient Name",
      shAge: "Age",
      shAdmDate: "Admission Date",
      shAdmFrom: "Admission From",
      shConsultant: "Consultant",
      shComplaints: "Current Complaints",
      shDiagnosis: "Diagnosis",
      shConnection: "Connections",
      shInfusion: "Infusions",
      shDiet: "Diet",
      shHistory: "History",
      shChief: "Chief Complaint",
      shAllergy: "Allergy",
      shIsolation: "Isolation",
      shGcs: "GCS",
      shFall: "Fall Risk",
      shVent: "Ventilation",
      shBedsore: "Bed sore",
      shRestraint: "Restraint",
      shFindings: "Significant findings",
      shMedsTitle: "Medications",
      shMedName: "Name",
      shMedDose: "Dose",
      shMedFreq: "Frequency",
      shMedRoute: "Route",
      shPlanTitle: "Plan / Orders",
      shRisksTitle: "Risks / Consultations",
      shNurseLabel: "Handover nurse",
      shRecvLabel: "Receiving nurse",
      sheetSecI: "Identification",
      sheetSecS: "Situation",
      sheetSecB: "Background",
      sheetSecA: "Assessment & Recommendations"
    }
  };

  let currentLanguage = 'ar';
  let editingId = null;
  let medCounter = 0;

  const STORAGE_KEY = "isbarPatients_v2";

  // =========================
  // Helpers
  // =========================
  function t(key){
    return (i18n[currentLanguage] && i18n[currentLanguage][key]) || key;
  }
  function setText(el, text){ if(el) el.textContent = text; }

  function todayISO(){
    return new Date().toISOString().slice(0,10);
  }

  function nowParts(){
    const d = new Date();
    const date = d.toLocaleDateString(currentLanguage === 'ar' ? 'ar-EG' : 'en-GB');
    const time = d.toLocaleTimeString(currentLanguage === 'ar' ? 'ar-EG' : 'en-GB', { hour: '2-digit', minute:'2-digit' });
    return { date, time };
  }

  function safeId(){
    try{
      if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
    }catch(e){}
    return String(Date.now());
  }

  function getPatients(){
    try{
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }catch(e){
      return [];
    }
  }
  function setPatients(arr){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }

  function collectForm(){
    return {
      room: document.getElementById('room').value.trim(),
      mrn: document.getElementById('mrn').value.trim(),
      ptName: document.getElementById('ptName').value.trim(),
      age: document.getElementById('age').value.trim(),
      admDate: document.getElementById('admDate').value,
      admFrom: document.getElementById('admFrom').value.trim(),
      consultant: document.getElementById('consultant').value.trim(),
      complaints: document.getElementById('complaints').value.trim(),
      diagnosis: document.getElementById('diagnosis').value.trim(),
      connection: document.getElementById('connection').value.trim(),
      infusion: document.getElementById('infusion').value.trim(),
      diet: document.getElementById('diet').value.trim(),
      history: document.getElementById('history').value.trim(),
      chiefComplaint: document.getElementById('chiefComplaint').value.trim(),
      allergy: document.getElementById('allergy').value.trim(),
      isolation: document.getElementById('isolation').value.trim(),
      medications: getMedications(),
      gcs: document.getElementById('gcs').value.trim(),
      fallRisk: document.getElementById('fallRisk').value.trim(),
      vent: document.getElementById('vent').value.trim(),
      bedsore: document.getElementById('bedsore').value.trim(),
      restraint: document.getElementById('restraint').value.trim(),
      findings: document.getElementById('findings').value.trim(),
      plan: document.getElementById('plan').value.trim(),
      orders: document.getElementById('orders').value.trim(),
      cultures: document.getElementById('cultures').value.trim(),
      consult: document.getElementById('consult').value.trim(),
      risks: document.getElementById('risks').value.trim(),
      nurseSignature: document.getElementById('nurseSignature').value.trim(),
      receivingNurse: document.getElementById('receivingNurse').value.trim(),
    };
  }

  function fillForm(p){
    document.getElementById('room').value = p.room || '';
    document.getElementById('mrn').value = p.mrn || '';
    document.getElementById('ptName').value = p.ptName || '';
    document.getElementById('age').value = p.age || '';
    document.getElementById('admDate').value = p.admDate || '';
    document.getElementById('admFrom').value = p.admFrom || '';
    document.getElementById('consultant').value = p.consultant || '';
    document.getElementById('complaints').value = p.complaints || '';
    document.getElementById('diagnosis').value = p.diagnosis || '';
    document.getElementById('connection').value = p.connection || '';
    document.getElementById('infusion').value = p.infusion || '';
    document.getElementById('diet').value = p.diet || '';
    document.getElementById('history').value = p.history || '';
    document.getElementById('chiefComplaint').value = p.chiefComplaint || '';
    document.getElementById('allergy').value = p.allergy || '';
    document.getElementById('isolation').value = p.isolation || '';
    document.getElementById('gcs').value = p.gcs || '';
    document.getElementById('fallRisk').value = p.fallRisk || '';
    document.getElementById('vent').value = p.vent || '';
    document.getElementById('bedsore').value = p.bedsore || '';
    document.getElementById('restraint').value = p.restraint || '';
    document.getElementById('findings').value = p.findings || '';
    document.getElementById('plan').value = p.plan || '';
    document.getElementById('orders').value = p.orders || '';
    document.getElementById('cultures').value = p.cultures || '';
    document.getElementById('consult').value = p.consult || '';
    document.getElementById('risks').value = p.risks || '';
    document.getElementById('nurseSignature').value = (p.nurseSignature || 'MR. ');
    document.getElementById('receivingNurse').value = (p.receivingNurse || '');

    // meds
    clearMedsUI();
    if (p.medications && p.medications.length){
      p.medications.forEach(m => addMedication(m));
    }else{
      showNoMeds(true);
    }
  }

  // =========================
  // Language
  // =========================
  function setLanguage(lang){
    currentLanguage = lang;

    const html = document.getElementById('htmlRoot');
    html.lang = lang;
    html.dir = (lang === 'ar') ? 'rtl' : 'ltr';

    // Button state
    document.getElementById('langArBtn').classList.toggle('chipActive', lang === 'ar');
    document.getElementById('langEnBtn').classList.toggle('chipActive', lang === 'en');

    // Replace all [data-i18n]
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      el.textContent = t(key);
    });

    // Search placeholder
    document.getElementById('searchPatient').placeholder = t('searchPlaceholder');

    // Update dynamic parts
    updateSaveButtonText();
    renderPatientsList(document.getElementById('searchPatient').value || '');

    // Update meds labels inside existing items
    document.querySelectorAll('.medItem').forEach(item => {
      item.querySelector('[data-med-label="name"]').textContent = t('medName');
      item.querySelector('[data-med-label="dose"]').textContent = t('medDose');
      item.querySelector('[data-med-label="freq"]').textContent = t('medFreq');
      item.querySelector('[data-med-label="route"]').textContent = t('medRoute');
      item.querySelector('[data-med-label="notes"]').textContent = t('medNotes');
      item.querySelector('[data-med-action="delete"]').textContent = t('btnDelete');
    });
  }

  // =========================
  // Medications
  // =========================
  function showNoMeds(show){
    document.getElementById('noMeds').style.display = show ? 'block' : 'none';
  }

  function clearMedsUI(){
    document.querySelectorAll('.medItem').forEach(x => x.remove());
    medCounter = 0;
  }

  function addMedication(prefill = null){
    medCounter++;
    showNoMeds(false);

    const container = document.getElementById('medicationsContainer');

    const wrap = document.createElement('div');
    wrap.className = 'medItem';
    wrap.id = `med-${medCounter}`;

    const routeOptions = [
      {v:'PO', t:'PO'},
      {v:'IV', t:'IV'},
      {v:'IM', t:'IM'},
      {v:'SC', t:'SC'},
      {v:'Topical', t:'Topical'},
      {v:'Inhalation', t:'Inhalation'},
      {v:'Other', t:'Other'},
    ];

    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
        <div class="field">
          <label data-med-label="name">${t('medName')}</label>
          <input class="med-name" dir="auto" placeholder="Paracetamol" value="${prefill?.name ? escapeHtml(prefill.name) : ''}">
        </div>
        <div class="field">
          <label data-med-label="dose">${t('medDose')}</label>
          <input class="med-dose" dir="auto" placeholder="500 mg" value="${prefill?.dose ? escapeHtml(prefill.dose) : ''}">
        </div>
        <div class="field">
          <label data-med-label="freq">${t('medFreq')}</label>
          <input class="med-freq" dir="auto" placeholder="q6h" value="${prefill?.frequency ? escapeHtml(prefill.frequency) : ''}">
        </div>
        <div class="field">
          <label data-med-label="route">${t('medRoute')}</label>
          <select class="med-route">
            ${routeOptions.map(o => `<option value="${o.v}" ${prefill?.route === o.v ? 'selected' : ''}>${o.t}</option>`).join('')}
          </select>
        </div>
        <div class="field flex items-end">
          <button type="button" class="btn btnDanger w-full" data-med-action="delete" onclick="deleteMedication('${wrap.id}')">${t('btnDelete')}</button>
        </div>
      </div>
      <div class="mt-3 field">
        <label data-med-label="notes">${t('medNotes')}</label>
        <textarea class="med-notes" dir="auto" placeholder="...">${prefill?.notes ? escapeHtml(prefill.notes) : ''}</textarea>
      </div>
    `;
    container.appendChild(wrap);
  }

  function deleteMedication(id){
    const el = document.getElementById(id);
    if (el) el.remove();

    if (document.querySelectorAll('.medItem').length === 0){
      showNoMeds(true);
    }
  }

  function getMedications(){
    const meds = [];
    document.querySelectorAll('.medItem').forEach(item => {
      const name = item.querySelector('.med-name')?.value.trim() || '';
      const dose = item.querySelector('.med-dose')?.value.trim() || '';
      const frequency = item.querySelector('.med-freq')?.value.trim() || '';
      const route = item.querySelector('.med-route')?.value || '';
      const notes = item.querySelector('.med-notes')?.value.trim() || '';

      if (name || dose || frequency || route || notes){
        meds.push({ name, dose, frequency, route, notes });
      }
    });
    return meds;
  }

  // =========================
  // Patients CRUD
  // =========================
  function setEditing(id, patient = null){
    editingId = id;

    const badge = document.getElementById('editingBadge');
    const cancelBtn = document.getElementById('cancelEditBtn');
    const info = document.getElementById('editingInfo');

    if (editingId){
      badge.style.display = 'inline-flex';
      cancelBtn.style.display = 'inline-flex';
      info.textContent = patient ? `${patient.ptName || ''} • ${patient.room ? (t('labelRoom') + ' ' + patient.room) : ''}` : '';
    }else{
      badge.style.display = 'none';
      cancelBtn.style.display = 'none';
      info.textContent = '';
    }

    updateSaveButtonText();
  }

  function updateSaveButtonText(){
    const el = document.getElementById('saveBtnText');
    if (!el) return;

    if (editingId){
      el.textContent = t('btnUpdate');
    }else{
      el.textContent = t('btnSave');
    }
  }

  function savePatient(){
    const data = collectForm();

    // Minimal validation
    if (!data.ptName && !data.room && !data.mrn){
      alert(currentLanguage === 'ar' ? 'من فضلك أدخل على الأقل (اسم / غرفة / رقم ملف).' : 'Please enter at least (Name / Room / MRN).');
      return;
    }

    const patients = getPatients();
    const now = new Date().toISOString();

    if (editingId){
      const idx = patients.findIndex(p => p.id === editingId);
      if (idx !== -1){
        patients[idx] = { ...patients[idx], ...data, updatedAt: now };
      }else{
        // If record missing, save as new
        patients.unshift({ id: editingId, ...data, createdAt: now, updatedAt: now });
      }
    }else{
      patients.unshift({ id: safeId(), ...data, createdAt: now, updatedAt: now });
    }

    setPatients(patients);
    renderPatientsList(document.getElementById('searchPatient').value || '');

    alert(currentLanguage === 'ar' ? 'تم الحفظ بنجاح.' : 'Saved successfully.');
  }

  function loadPatient(id){
    const patients = getPatients();
    const p = patients.find(x => x.id === id);
    if (!p) return;

    fillForm(p);
    setEditing(id, p);

    // Scroll to top so user sees the form
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function duplicatePatient(id){
    const patients = getPatients();
    const p = patients.find(x => x.id === id);
    if (!p) return;

    const now = new Date().toISOString();
    const copy = { ...p, id: safeId(), createdAt: now, updatedAt: now };
    patients.unshift(copy);
    setPatients(patients);

    renderPatientsList(document.getElementById('searchPatient').value || '');
    alert(currentLanguage === 'ar' ? 'تم إنشاء نسخة جديدة.' : 'Duplicated as a new record.');
  }

  function deletePatient(id){
    if (!confirm(currentLanguage === 'ar' ? 'حذف هذا المريض؟' : 'Delete this patient?')) return;

    let patients = getPatients();
    patients = patients.filter(p => p.id !== id);
    setPatients(patients);

    if (editingId === id){
      cancelEdit();
    }

    renderPatientsList(document.getElementById('searchPatient').value || '');
  }

  function deleteAllPatients(){
    if (!confirm(currentLanguage === 'ar' ? 'حذف جميع المرضى نهائياً؟ لا يمكن التراجع.' : 'Delete all patients permanently? This cannot be undone.')) return;
    localStorage.removeItem(STORAGE_KEY);
    cancelEdit();
    renderPatientsList('');
  }

  function cancelEdit(){
    setEditing(null);
  }

  function newPatient(){
    cancelEdit();
    clearForm(false);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function clearForm(ask){
    if (ask){
      if (!confirm(currentLanguage === 'ar' ? 'مسح النموذج الحالي؟' : 'Clear current form?')) return;
    }

    document.querySelectorAll('input, textarea').forEach(el => {
      if (['searchPatient'].includes(el.id)) return;
      if (el.type === 'date') return;
      el.value = '';
    });

    document.getElementById('admDate').value = todayISO();
    document.getElementById('nurseSignature').value = 'MR. ';

    clearMedsUI();
    showNoMeds(true);
  }

  function renderPatientsList(filter){
    const q = (filter || '').toLowerCase().trim();
    const list = document.getElementById('patientsList');
    const patients = getPatients();

    const filtered = patients.filter(p => {
      const hay = [
        p.ptName || '',
        p.room || '',
        p.mrn || '',
        p.consultant || ''
      ].join(' ').toLowerCase();

      return hay.includes(q);
    });

    list.innerHTML = '';

    if (filtered.length === 0){
      list.innerHTML = `<div class="text-center text-sm text-[color:var(--muted)] py-6">${currentLanguage === 'ar' ? 'لا توجد نتائج.' : 'No results.'}</div>`;
    }else{
      filtered.forEach(p => {
        const box = document.createElement('div');
        box.className = 'bg-[rgba(0,0,0,.12)] border border-white/10 rounded-2xl p-4 flex flex-col lg:flex-row gap-3 lg:items-center lg:justify-between';

        const meta = [];
        if (p.room) meta.push(`${t('labelRoom')}: ${escapeHtml(p.room)}`);
        if (p.mrn) meta.push(`${t('labelMrn')}: ${escapeHtml(p.mrn)}`);
        if (p.admDate) meta.push(`${t('labelAdmDate')}: ${escapeHtml(p.admDate)}`);
        if (p.updatedAt) meta.push(`${currentLanguage === 'ar' ? 'آخر تحديث' : 'Updated'}: ${formatDateTime(p.updatedAt)}`);

        box.innerHTML = `
          <div class="min-w-0">
            <div class="flex flex-wrap items-center gap-2">
              <div class="font-extrabold text-base truncate">${escapeHtml(p.ptName || (currentLanguage === 'ar' ? 'بدون اسم' : 'Unnamed'))}</div>
              ${editingId === p.id ? `<span class="chip chipActive">${t('editingBadge')}</span>` : ''}
              ${p.medications && p.medications.length ? `<span class="chip">${p.medications.length} ${currentLanguage === 'ar' ? 'دواء' : 'med(s)'}</span>` : ''}
            </div>
            <div class="mt-1 text-xs text-[color:var(--muted)] break-words">${meta.join(' • ')}</div>
          </div>

          <div class="flex flex-wrap gap-2 justify-end">
            <button class="btn btnGhost" type="button" onclick="loadPatient('${p.id}')">${currentLanguage === 'ar' ? 'تحميل/تعديل' : 'Load/Edit'}</button>
            <button class="btn btnSecondary" type="button" onclick="duplicatePatient('${p.id}')">${currentLanguage === 'ar' ? 'نسخ' : 'Duplicate'}</button>
            <button class="btn btnDanger" type="button" onclick="deletePatient('${p.id}')">${currentLanguage === 'ar' ? 'حذف' : 'Delete'}</button>
          </div>
        `;
        list.appendChild(box);
      });
    }

    document.getElementById('patientsCount').textContent =
      (currentLanguage === 'ar')
        ? `الإجمالي: ${patients.length} • المعروض: ${filtered.length}`
        : `Total: ${patients.length} • Showing: ${filtered.length}`;
  }

  function formatDateTime(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString(currentLanguage === 'ar' ? 'ar-EG' : 'en-GB');
    }catch(e){
      return iso;
    }
  }

  // =========================
  // Export: Nursing Handover form (Image -> PDF)
  // =========================
  function applySheetLanguage(lang){
    const sheet = document.getElementById('exportSheet');
    sheet.lang = lang;
    sheet.dir = (lang === 'ar') ? 'rtl' : 'ltr';

    // Apply text translations to sheet labels
    const dict = i18n[lang];

    setText(document.getElementById('sheetTitle'), dict.sheetTitle);
    setText(document.getElementById('sheetSub'), dict.sheetSub);
    setText(document.getElementById('sheetSideTitle'), dict.sheetSide);
    setText(document.getElementById('sheetMetaDateLabel'), dict.sheetMetaDate);
    setText(document.getElementById('sheetMetaTimeLabel'), dict.sheetMetaTime);

    setText(document.getElementById('sheetSecI'), dict.sheetSecI);
    setText(document.getElementById('sheetSecS'), dict.sheetSecS);
    setText(document.getElementById('sheetSecB'), dict.sheetSecB);
    setText(document.getElementById('sheetSecA'), dict.sheetSecA);

    setText(document.getElementById('shRoom'), dict.shRoom);
    setText(document.getElementById('shMrn'), dict.shMrn);
    setText(document.getElementById('shName'), dict.shName);
    setText(document.getElementById('shAge'), dict.shAge);
    setText(document.getElementById('shAdmDate'), dict.shAdmDate);
    setText(document.getElementById('shAdmFrom'), dict.shAdmFrom);
    setText(document.getElementById('shConsultant'), dict.shConsultant);

    setText(document.getElementById('shComplaints'), dict.shComplaints);
    setText(document.getElementById('shDiagnosis'), dict.shDiagnosis);
    setText(document.getElementById('shConnection'), dict.shConnection);
    setText(document.getElementById('shInfusion'), dict.shInfusion);
    setText(document.getElementById('shDiet'), dict.shDiet);

    setText(document.getElementById('shHistory'), dict.shHistory);
    setText(document.getElementById('shChief'), dict.shChief);
    setText(document.getElementById('shAllergy'), dict.shAllergy);
    setText(document.getElementById('shIsolation'), dict.shIsolation);

    setText(document.getElementById('shGcs'), dict.shGcs);
    setText(document.getElementById('shFall'), dict.shFall);
    setText(document.getElementById('shVent'), dict.shVent);
    setText(document.getElementById('shBedsore'), dict.shBedsore);
    setText(document.getElementById('shRestraint'), dict.shRestraint);
    setText(document.getElementById('shFindings'), dict.shFindings);

    setText(document.getElementById('shMedsTitle'), dict.shMedsTitle);
    setText(document.getElementById('shMedName'), dict.shMedName);
    setText(document.getElementById('shMedDose'), dict.shMedDose);
    setText(document.getElementById('shMedFreq'), dict.shMedFreq);
    setText(document.getElementById('shMedRoute'), dict.shMedRoute);

    setText(document.getElementById('shPlanTitle'), dict.shPlanTitle);
    setText(document.getElementById('shRisksTitle'), dict.shRisksTitle);

    setText(document.getElementById('shNurseLabel'), dict.shNurseLabel);
    setText(document.getElementById('shRecvLabel'), dict.shRecvLabel);
  }

  function fillSheetValues(data, lang){
    // Date/time
    const d = new Date();
    const exportDate = d.toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-GB');
    const exportTime = d.toLocaleTimeString(lang === 'ar' ? 'ar-EG' : 'en-GB', { hour:'2-digit', minute:'2-digit' });

    const values = {
      ...data,
      exportDate,
      exportTime,
      admDate: data.admDate || ''
    };

    document.querySelectorAll('[data-sheet-value]').forEach(el => {
      const k = el.getAttribute('data-sheet-value');
      el.textContent = values[k] || '';
    });

    // meds table
    const body = document.getElementById('sheetMedsBody');
    body.innerHTML = '';
    const meds = (data.medications || []).slice(0, 8); // cap to fit the sheet
    if (meds.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="4" style="text-align:center; font-weight:700; color:#444;">${lang === 'ar' ? 'لا توجد أدوية' : 'No medications'}</td>`;
      body.appendChild(tr);
      return;
    }

    meds.forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(m.name || '')}</td>
        <td>${escapeHtml(m.dose || '')}</td>
        <td>${escapeHtml(m.frequency || '')}</td>
        <td>${escapeHtml(m.route || '')}</td>
      `;
      body.appendChild(tr);
    });
  }

  async function exportHandoverPDF(lang){
    // Keep current UI language; export language is independent.
    const data = collectForm();

    // Make sure sheet uses requested language
    applySheetLanguage(lang);
    fillSheetValues(data, lang);

    // Render to canvas
    const sheet = document.getElementById('exportSheet');

    // Wait a tick to ensure DOM updates
    await new Promise(r => setTimeout(r, 50));

    const canvas = await html2canvas(sheet, {
      scale: 2,
      backgroundColor: '#ffffff',
      useCORS: true,
      logging: false
    });

    const imgData = canvas.toDataURL('image/png', 1.0);

    // A4 landscape: 297mm x 210mm
    const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4', compress: true });
    doc.addImage(imgData, 'PNG', 0, 0, 297, 210, undefined, 'FAST');

    const safeName = (data.ptName || 'Patient').replace(/\s+/g, '_').replace(/[^\w\-]+/g, '');
    const date = new Date().toISOString().slice(0,10);
    doc.save(`Nursing_Handover_${safeName}_${lang.toUpperCase()}_${date}.pdf`);
  }

  // =========================
  // Export CSV (medications)
  // =========================
  function exportMedicationsCSV(){
    const meds = getMedications();
    if (!meds.length){
      alert(currentLanguage === 'ar' ? 'لا توجد أدوية للتصدير.' : 'No medications to export.');
      return;
    }

    const header = ['name','dose','frequency','route','notes'];
    const rows = meds.map(m => header.map(k => csvCell(m[k] || '')).join(','));
    const csv = header.join(',') + '\n' + rows.join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `medications_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }
  function csvCell(v){
    const s = String(v).replace(/"/g, '""');
    return `"${s}"`;
  }

  // =========================
  // Export/Import JSON
  // =========================
  function exportAllPatientsJSON(){
    const patients = getPatients();
    const payload = {
      exportedAt: new Date().toISOString(),
      version: 2,
      patients
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `patients_isbar_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  async function importPatientsJSON(file){
    if (!file) return;
    try{
      const text = await file.text();
      const json = JSON.parse(text);

      if (!json || !Array.isArray(json.patients)){
        alert(currentLanguage === 'ar' ? 'ملف JSON غير صالح.' : 'Invalid JSON file.');
        return;
      }

      const existing = getPatients();
      const merged = [...json.patients, ...existing];

      // De-duplicate by id (keep newest first)
      const seen = new Set();
      const unique = [];
      for (const p of merged){
        if (!p || !p.id) continue;
        if (seen.has(p.id)) continue;
        seen.add(p.id);
        unique.push(p);
      }

      setPatients(unique);
      renderPatientsList(document.getElementById('searchPatient').value || '');
      alert(currentLanguage === 'ar' ? 'تم الاستيراد بنجاح.' : 'Imported successfully.');
    }catch(e){
      console.error(e);
      alert(currentLanguage === 'ar' ? 'فشل الاستيراد.' : 'Import failed.');
    }
  }

  // =========================
  // Safety: escape HTML for list rendering
  // =========================
  function escapeHtml(str){
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  // =========================
  // Init
  // =========================
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('admDate').value = todayISO();

    // Default language: Arabic (change if you want)
    setLanguage('ar');

    renderPatientsList('');

    // If the user already has patients from old version, you can migrate here if needed.
  });
</script>
</body>
</html>
